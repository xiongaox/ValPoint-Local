# 投稿审核系统 - 实施计划

> 版本：v1.0
> 创建时间：2023-12-23
> 状态：Phase 1.5 ✅ | Phase 2 ✅ | Phase 3 ⏳

---

## 项目概述

为 ValPoint 共享库实现用户投稿功能，允许用户提交点位包供管理员审核，审核通过后自动添加到共享库。

### 核心流程

```
用户提交 ZIP → Supabase Storage 临时存储 → 管理员审核 → 通过后迁移到官方 OSS → 添加到共享库
```

---

## Phase 1.5 - 后台提交设置配置 ✅

### 数据库 Schema 更新

#### [MODIFY] system_settings 表
```sql
ALTER TABLE system_settings 
ADD COLUMN official_oss_config JSONB DEFAULT NULL,
ADD COLUMN submission_enabled BOOLEAN DEFAULT FALSE,
ADD COLUMN daily_submission_limit INTEGER DEFAULT 5;
```

### 代码修改

#### [MODIFY] src/lib/systemSettings.ts
- 更新 `SystemSettings` 接口添加新字段
- 更新 `updateSystemSettings` 函数支持新字段

#### [MODIFY] src/apps/admin/pages/SettingsPage.tsx
- 添加官方图床配置表单（支持阿里云/腾讯云/七牛云）
- 添加投稿功能开关（需先配置有效图床）
- 添加每日投稿次数限制输入

#### [MODIFY] src/apps/shared/SharedMainView.tsx
- 加载 `submission_enabled` 系统设置
- 传递给 `SharedRightPanel`

#### [MODIFY] src/apps/shared/SharedRightPanel.tsx
- 根据 `submissionEnabled` 条件渲染投稿相关 Tab

---

## Phase 2 - 管理员审核系统 ✅

### 数据库 Schema

#### [NEW] lineup_submissions 表
```sql
CREATE TABLE lineup_submissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    submitter_id UUID NOT NULL REFERENCES auth.users(id),
    submitter_email TEXT,
    title TEXT NOT NULL,
    map_name TEXT NOT NULL,
    agent_name TEXT NOT NULL,
    agent_icon TEXT,
    skill_icon TEXT,
    side TEXT NOT NULL DEFAULT 'attack',
    ability_index INTEGER,
    agent_pos JSONB,
    skill_pos JSONB,
    description TEXT,
    stand_img TEXT,
    stand_desc TEXT,
    aim_img TEXT,
    aim_desc TEXT,
    aim2_img TEXT,
    aim2_desc TEXT,
    land_img TEXT,
    land_desc TEXT,
    source_link TEXT,
    author_name TEXT,
    author_avatar TEXT,
    author_uid TEXT,
    status TEXT NOT NULL DEFAULT 'pending',
    reject_reason TEXT,
    reviewed_by UUID,
    reviewed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 新增文件

#### [NEW] src/types/submission.ts
- `SubmissionStatus` - 投稿状态枚举
- `LineupPosition` - 坐标类型（lat/lng）
- `LineupSubmission` - 投稿数据接口
- `SubmissionFormData` - 投稿表单接口

#### [NEW] src/lib/submissionUpload.ts
- `parseSubmissionZip()` - 解析用户上传的 ZIP 文件
- `uploadImageToStorage()` - 上传图片到 Supabase Storage
- `submitLineup()` - 完整的投稿流程
- `checkDailySubmissionLimit()` - 检查每日投稿限制

#### [NEW] src/lib/reviewService.ts
- `getPendingSubmissions()` - 获取待审核投稿列表
- `approveSubmission()` - 审核通过（迁移图片 + 创建记录）
- `rejectSubmission()` - 审核拒绝（记录理由）
- `migrateImagesToOss()` - 将图片从 Storage 迁移到官方 OSS

#### [NEW] src/apps/admin/components/ReviewMapPreview.tsx
- 地图预览组件
- 支持滚轮缩放和拖拽
- 显示角色头像和技能图标
- Y 轴镜像坐标转换

#### [NEW] src/apps/admin/pages/LineupReviewPage.tsx
- 三栏布局审核页面
- 左侧：待审投稿列表
- 中间：地图预览（带标记）
- 右侧：详情、图片预览、操作按钮

### 路由集成

#### [MODIFY] src/apps/admin/AdminApp.tsx
- 添加 `LineupReviewPage` 路由

#### [MODIFY] src/apps/admin/components/AdminLayout.tsx
- 添加"审核投稿"导航菜单项

---

## Phase 3 - 增强功能 ⏳

### 3.1 自动清理过期文件

#### [NEW] supabase/functions/cleanup-submissions/index.ts
```typescript
// Supabase Edge Function
// 每天执行，清理已处理超过 7 天的投稿临时文件

export async function handler() {
  // 1. 查询状态为 approved/rejected 且 updated_at < 7天前 的记录
  // 2. 删除对应 Storage 文件
  // 3. 更新记录标记为已清理
}
```

### 3.2 投稿状态通知

#### [MODIFY] src/apps/shared/SharedRightPanel.tsx
- 在"待审点位"Tab 显示用户自己的投稿状态
- 被拒绝的显示拒绝理由

#### [NEW] src/apps/shared/components/MySubmissions.tsx
- 我的投稿列表组件
- 显示 pending/approved/rejected 状态
- 点击查看详情

### 3.3 邮件通知（可选）

#### [NEW] src/lib/notificationService.ts
- 投稿被拒绝时发送邮件通知
- 需配置 SMTP 或使用 Supabase Edge Function

---

## 技术细节

### 坐标系统
- 地图使用 0-1000 坐标系
- 审核页面预览需要 Y 轴镜像：`top = (1000 - lat) / 1000 * 100%`
- 标记大小随缩放反向调整：`size / scale`

### 图片存储策略
1. **临时存储**：用户投稿 → Supabase Storage `submissions/{userId}/{submissionId}/`
2. **审核通过**：迁移到官方 OSS，删除临时文件
3. **审核拒绝**：保留 7 天后自动清理

### RLS 策略
```sql
-- lineup_submissions 表
- 用户只能查看/操作自己的投稿
- 管理员可以查看所有投稿

-- storage.objects (submissions bucket)
- 认证用户可以上传
- 公开可读
```

---

## 文件清单

### 新增文件
```
src/types/submission.ts
src/lib/submissionUpload.ts
src/lib/reviewService.ts
src/apps/admin/components/ReviewMapPreview.tsx
src/apps/admin/pages/LineupReviewPage.tsx
supabase/migrations/20231223_create_lineup_submissions.sql
supabase/migrations/20231223_add_submission_enabled.sql
supabase/migrations/20231223_storage_policies.sql
```

### 修改文件
```
src/lib/systemSettings.ts
src/apps/admin/pages/SettingsPage.tsx
src/apps/admin/AdminApp.tsx
src/apps/admin/components/AdminLayout.tsx
src/apps/shared/SharedMainView.tsx
src/apps/shared/SharedRightPanel.tsx
```

---

## 验证步骤

### Phase 1.5 验证
- [ ] 后台设置页面可以配置官方图床
- [ ] 投稿开关在未配置图床时禁用
- [ ] 共享库投稿 Tab 根据设置显示/隐藏

### Phase 2 验证
- [ ] 用户可以上传 ZIP 投稿
- [ ] 管理员可以查看待审列表
- [ ] 地图预览正确显示位置
- [ ] 审核通过后图片迁移到 OSS
- [ ] 审核拒绝后记录理由

### Phase 3 验证
- [ ] 过期文件自动清理
- [ ] 用户可以查看投稿状态
- [ ] 被拒绝时收到通知
