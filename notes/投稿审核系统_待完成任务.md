# æŠ•ç¨¿å®¡æ ¸ç³»ç»Ÿ - æœªå®Œæˆä»»åŠ¡æ¸…å•

> åˆ›å»ºæ—¶é—´ï¼š2023-12-23 17:35
> çŠ¶æ€ï¼šPhase 1.5 å’Œ Phase 2 å·²å®Œæˆï¼ŒPhase 3 å¾…å¼€å§‹

---

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### Phase 1.5 - åå°æäº¤è®¾ç½®é…ç½®
- [x] æ•°æ®åº“æ·»åŠ  `official_oss_config`ã€`submission_enabled`ã€`daily_submission_limit` å­—æ®µ
- [x] `SettingsPage.tsx` æ·»åŠ å®˜æ–¹å›¾åºŠé…ç½® UI
- [x] `SettingsPage.tsx` æ·»åŠ æŠ•ç¨¿å¼€å…³å’Œæ¯æ—¥é™åˆ¶è®¾ç½®
- [x] å…±äº«åº“æ ¹æ® `submission_enabled` åŠ¨æ€æ˜¾ç¤º/éšè—æŠ•ç¨¿ Tab

### Phase 2 - ç®¡ç†å‘˜å®¡æ ¸ç³»ç»Ÿ
- [x] åˆ›å»º `reviewService.ts` å®¡æ ¸æœåŠ¡
- [x] åˆ›å»º `LineupReviewPage.tsx` å®¡æ ¸é¡µé¢
- [x] ä¸‰æ å¸ƒå±€ï¼šå¾…å®¡åˆ—è¡¨ / åœ°å›¾é¢„è§ˆ / è¯¦æƒ…+æ“ä½œ
- [x] åœ°å›¾é¢„è§ˆæ”¯æŒç¼©æ”¾ã€æ‹–æ‹½ã€åæ ‡é•œåƒ
- [x] å®¡æ ¸é€šè¿‡ï¼ˆè¿ç§»å›¾ç‰‡åˆ°å®˜æ–¹ OSSï¼‰
- [x] å®¡æ ¸æ‹’ç»ï¼ˆè®°å½•æ‹’ç»ç†ç”±ï¼‰
- [x] åˆ›å»º `ReviewMapPreview.tsx` åœ°å›¾é¢„è§ˆç»„ä»¶

---

## âš ï¸ é˜»å¡é—®é¢˜ï¼ˆéœ€å…ˆè§£å†³ï¼‰

### Supabase Storage RLS ç­–ç•¥
**é—®é¢˜**ï¼šæŠ•ç¨¿æ—¶æŠ¥é”™ "new row violates row-level security policy"

**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨ Supabase SQL Editor æ‰§è¡Œï¼š
```sql
-- åˆ é™¤å¯èƒ½å†²çªçš„æ—§ç­–ç•¥
DROP POLICY IF EXISTS "Users can upload to own folder" ON storage.objects;
DROP POLICY IF EXISTS "Public can view submissions" ON storage.objects;

-- åˆ›å»ºæ–°ç­–ç•¥
CREATE POLICY "Users can upload to submissions"
ON storage.objects FOR INSERT TO authenticated
WITH CHECK (bucket_id = 'submissions');

CREATE POLICY "Anyone can view submissions"
ON storage.objects FOR SELECT TO public
USING (bucket_id = 'submissions');
```

æˆ–è€…é€šè¿‡ Supabase åå° **Storage â†’ submissions â†’ Policies** æ‰‹åŠ¨é…ç½®ã€‚

---

## ğŸ“‹ Phase 3 - å¾…å®Œæˆä»»åŠ¡

### 3.1 è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¸´æ—¶æ–‡ä»¶
**ç›®çš„**ï¼šå®šæœŸæ¸…ç† Supabase Storage ä¸­çš„ä¸´æ—¶æŠ•ç¨¿å›¾ç‰‡

**å®ç°æ–¹æ¡ˆ**ï¼š
1. åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼ˆSupabase Edge Function æˆ– cron jobï¼‰
2. æŸ¥è¯¢ `lineup_submissions` è¡¨ä¸­çŠ¶æ€ä¸º `approved` æˆ– `rejected` è¶…è¿‡ 7 å¤©çš„è®°å½•
3. åˆ é™¤å¯¹åº”çš„ Storage æ–‡ä»¶
4. å¯é€‰ï¼šåˆ é™¤æ•°æ®åº“è®°å½•æˆ–æ ‡è®°ä¸ºå·²æ¸…ç†

**æ¶‰åŠæ–‡ä»¶**ï¼š
- æ–°å»º `supabase/functions/cleanup-submissions/index.ts`
- æˆ–åœ¨ `reviewService.ts` ä¸­æ·»åŠ æ¸…ç†é€»è¾‘

### 3.2 è¢«æ‹’ç»æŠ•ç¨¿çš„é€šçŸ¥åŠŸèƒ½
**ç›®çš„**ï¼šå½“æŠ•ç¨¿è¢«æ‹’ç»æ—¶ï¼Œé€šçŸ¥æŠ•ç¨¿è€…å¹¶è¯´æ˜æ‹’ç»ç†ç”±

**å®ç°æ–¹æ¡ˆ**ï¼š
1. ä½¿ç”¨ Supabase çš„ Realtime æˆ–è½®è¯¢æœºåˆ¶
2. åœ¨å…±äº«åº“çš„"å¾…å®¡ç‚¹ä½" Tab æ˜¾ç¤ºè¢«æ‹’ç»çš„æŠ•ç¨¿åŠç†ç”±
3. å¯é€‰ï¼šé›†æˆé‚®ä»¶é€šçŸ¥ï¼ˆéœ€é…ç½® SMTPï¼‰

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `src/apps/shared/SharedRightPanel.tsx` - æ·»åŠ è¢«æ‹’ç»æŠ•ç¨¿çš„æ˜¾ç¤º
- æ–°å»º `src/lib/notificationService.ts` - é€šçŸ¥æœåŠ¡

### 3.3 æŠ•ç¨¿å†å²è®°å½•
**ç›®çš„**ï¼šè®©ç”¨æˆ·æŸ¥çœ‹è‡ªå·±çš„æŠ•ç¨¿å†å²å’ŒçŠ¶æ€

**å®ç°æ–¹æ¡ˆ**ï¼š
1. åœ¨å…±äº«åº“æ·»åŠ "æˆ‘çš„æŠ•ç¨¿"Tab
2. æ˜¾ç¤ºæ‰€æœ‰æŠ•ç¨¿ï¼ˆpending/approved/rejectedï¼‰
3. è¢«æ‹’ç»çš„æ˜¾ç¤ºæ‹’ç»ç†ç”±

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `src/apps/shared/SharedRightPanel.tsx`
- æ–°å»º `src/apps/shared/components/MySubmissions.tsx`

---

## ğŸ“ ç›¸å…³æ–‡ä»¶è·¯å¾„

### æ ¸å¿ƒæ–‡ä»¶
- `src/apps/admin/pages/LineupReviewPage.tsx` - å®¡æ ¸é¡µé¢
- `src/apps/admin/components/ReviewMapPreview.tsx` - åœ°å›¾é¢„è§ˆç»„ä»¶
- `src/lib/reviewService.ts` - å®¡æ ¸æœåŠ¡
- `src/lib/submissionUpload.ts` - æŠ•ç¨¿ä¸Šä¼ æœåŠ¡
- `src/apps/admin/pages/SettingsPage.tsx` - åå°è®¾ç½®é¡µé¢

### ç±»å‹å®šä¹‰
- `src/types/submission.ts` - æŠ•ç¨¿ç›¸å…³ç±»å‹

### æ•°æ®åº“è¿ç§»
- `supabase/migrations/20231223_create_lineup_submissions.sql`
- `supabase/migrations/20231223_add_submission_enabled.sql`
- `supabase/migrations/20231223_storage_policies.sql`

---

## ğŸ”§ å¼€å‘ç¯å¢ƒå¯åŠ¨

```bash
# åå°ç®¡ç†
npm run dev:admin

# å…±äº«åº“
npm run dev:shared

# ä¸ªäººåº“
npm run dev:user
```

---

## ğŸ“ å¤‡æ³¨

- å®¡æ ¸é¡µé¢çš„åœ°å›¾åæ ‡ä½¿ç”¨äº† Y è½´é•œåƒï¼š`top = (1000 - lat) / 1000 * 100%`
- æ ‡è®°å¤§å°å’Œæè¾¹éšç¼©æ”¾åå‘è°ƒæ•´ä¿æŒæ’å®šè§†è§‰æ•ˆæœ
- å®˜æ–¹å›¾åºŠé…ç½®å­˜å‚¨åœ¨ `system_settings.official_oss_config` å­—æ®µä¸­
