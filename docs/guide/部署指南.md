# 部署指南

**ValPoint** 可以部署到多个平台，推荐使用 `Vercel` 或 `Cloudflare Pages` 。

| 平台 | 是否真·一键 | README 按钮 | 自动 Fork | 环境变量引导
| :--- | :--- | :--- | :--- | :--- |
| Docker | ⭐⭐⭐⭐⭐ | N/A | N/A | ✅ 环境变量
| Vercel | ⭐⭐⭐⭐⭐ | ✅ 官方 | ✅ | ✅ 强制填写
| Cloudflare Pages | ⭐⭐⭐ | ⚠️ 半官方 | ❌ | ⚠️ 手动
| Zeabur | ⭐⭐⭐⭐ | ⚠️ 非官方 | ✅ | ⚠️ 部分

::: info 一句话结论

👉 私有部署首选：**Docker**

👉 对外开源首选：Vercel

👉 国内/边缘/CDN：Cloudflare Pages

👉 全栈 / 后端 / DB：Zeabur

:::

## 🐳 Docker 部署（推荐私有部署）

### 优势
- ✅ 完全自主可控
- ✅ 支持私有服务器
- ✅ 一键启动，无需 Node.js 环境
- ✅ 内置 Nginx 生产优化配置
- ✅ 环境变量灵活配置

### 方式一：使用 Docker Compose（推荐）

#### 1. 创建 docker-compose.yml

::: details 点击查看完整配置

```yaml
services:
  valpoint:
    image: xiongaox7806/valpoint-a:latest
    restart: always
    ports:
      - "3208:3208"
    environment:
      - NODE_ENV=production
      # Supabase 主库（个人点位数据存储，必填）
      - VITE_SUPABASE_URL=${VITE_SUPABASE_URL}
      - VITE_SUPABASE_ANON_KEY=${VITE_SUPABASE_ANON_KEY}
      # Supabase 共享库（公共点位数据，留空则使用主库）
      - VITE_SUPABASE_SHARE_URL=${VITE_SUPABASE_SHARE_URL}
      - VITE_SUPABASE_SHARE_ANON_KEY=${VITE_SUPABASE_SHARE_ANON_KEY}
    networks:
      - valpoint-net

networks:
  valpoint-net:
    driver: bridge
```

:::

> [!TIP]
> 将上述配置中的 `${VAR}` 替换为你的实际值。

#### 2. 启动服务

```bash
# 启动容器
docker compose up -d

# 查看运行状态
docker compose ps

# 查看日志
docker compose logs -f

# 停止服务
docker compose down
```

#### 4. 访问应用

| 入口 | 地址 |
|------|------|
| 共享库（首页）| `http://localhost:8080` |
| 个人库 | `http://localhost:8080/user.html` |
| 管理后台 | `http://localhost:8080/admin.html` |

### 方式二：使用 Docker 命令

```bash
# 拉取官方镜像
docker pull xiongaox7806/valpoint-a:latest

# 运行容器
docker run -d \
  --name valpoint \
  -p 8080:3208 \
  -e VITE_SUPABASE_URL=https://[PROJECT_ID].supabase.co \
  -e VITE_SUPABASE_ANON_KEY=[YOUR_ANON_KEY] \
  xiongaox7806/valpoint-a:latest
```

### 方式三：自行构建镜像

```bash
# 克隆项目
git clone https://github.com/xiongaox/valpoint.git
cd valpoint

# 构建镜像
docker build -t valpoint:local .

# 运行
docker compose up -d
```

::: warning MPA 架构说明
项目采用多页面应用（MPA）架构，包含以下入口：
- `index.html` - 共享库（首页）
- `user.html` - 个人库
- `admin.html` - 管理后台
- `wiki.html` - 使用文档
- `404.html` - 404 页面

Nginx 配置已自动处理路由重写。
:::

## 🚀 Vercel 部署（推荐）

### 优势
- ✅ 自动构建和部署
- ✅ 全球 CDN 加速
- ✅ 免费 SSL 证书
- ✅ 自动预览部署
- ✅ 环境变量管理

### 部署步骤

> [!IMPORTANT]
> 先将项目 Fork 到你的 GitHub 账号，然后连接 GitHub 部署。

#### 1. 一键部署

点击下面按钮一键部署

[![Deploy with Vercel](https://vercel.com/button)](
https://vercel.com/new/clone?repository-url=https://github.com/xiongaox/ValPoint&project-name=valpoint&repository-name=valpoint&env=VITE_SUPABASE_SHARE_ANON_KEY,VITE_SUPABASE_ANON_KEY,VITE_SUPABASE_URL,VITE_SUPABASE_SHARE_URL
)

#### 2. 手动部署（可选）

1. 访问 [vercel.com](https://vercel.com) → `New Project`
2. 选择仓库 → `Import`
3. 添加环境变量（`VITE_SUPABASE_URL`、`VITE_SUPABASE_ANON_KEY`）
4. 点击 `Deploy`

#### 3. 配置自定义域名（可选）

1. 在 `Vercel` 项目设置中点击 `Domains`
2. 添加你的域名
3. 按照提示配置 `DNS` 记录

### 自动部署

配置完成后，每次推送到 `GitHub` 都会自动触发部署：
- `main` 分支 → 生产环境
- 其他分支 → 预览环境

## 🚀 Cloudflare Pages 部署

### 优势
- ✅ 全球 `CDN` 网络
- ✅ 无限带宽
- ✅ 免费 `SSL` 证书
- ✅ 快速构建

### 部署步骤

> [!IMPORTANT]
> 先将项目 Fork 到你的 GitHub 账号，然后连接 GitHub 部署。

#### 1. 一键部署

点击下面按钮一键部署

[![Deploy to Cloudflare Pages](https://deploy.workers.cloudflare.com/button)](
https://dash.cloudflare.com/?to=/:account/pages/new
)

#### 2. 手动部署（可选）

1. 访问 [Cloudflare Pages](https://pages.cloudflare.com)
2. 点击 `Create a project` → 连接 GitHub
3. 选择 `ValPoint` 仓库
4. 构建配置：`npm run build`，输出目录 `dist`
5. 添加环境变量 → `Save and Deploy`

## 🚀 Zeabur 部署

### 优势
- ✅ 国内访问速度快
- ✅ 支持全栈部署
- ✅ 自动识别项目类型
- ✅ 免费额度充足

### 部署步骤

> [!IMPORTANT]
> 先将项目 Fork 到你的 GitHub 账号，然后连接 GitHub 部署。

#### 1. 一键部署

点击下面按钮部署

[![Deploy on Zeabur](https://zeabur.com/button.svg)](
https://zeabur.com/templates/github?repo=xiongaox/ValPoint
)

#### 2. 手动部署

##### 1. 注册并登录 Zeabur
- 访问 [zeabur.com](https://zeabur.com)
- 使用 GitHub 账号登录

##### 2. 创建新项目
- 在控制台点击 `Create Project`
- 选择区域

##### 3. 创建服务
- 点击 `Create Service`
- 选择 `Git`
- 搜索并选择你的 `ValPoint` 仓库

##### 4. 配置环境变量
- 在服务设置中找到 `Variables`
- 添加项目所需的 `Supabase` 环境变量

##### 5. 等待部署
- Zeabur 会自动识别项目类型并开始构建

## 🚀 自托管部署

### 使用 Nginx

#### 1. 构建项目

```bash
npm run build
```

#### 2. 配置 Nginx

```nginx
server {
    listen 80;
    server_name valpoint.example.com;
    
    root /var/www/valpoint/dist;
    index index.html;
    
    # SPA 路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}
```

#### 3. 部署文件

```bash
# 上传构建产物
scp -r dist/* user@server:/var/www/valpoint/dist/

# 重启 Nginx
ssh user@server "sudo systemctl restart nginx"
```

## ⚙️ 环境变量管理

### 开发环境

使用 `.env` 文件：

```env
VITE_SUPABASE_URL=https://[PROJECT_ID].supabase.co
VITE_SUPABASE_ANON_KEY=[YOUR_ANON_KEY]
```

### 生产环境

在部署平台的环境变量设置中配置：

| 平台 | 配置位置 |
|------|----------|
| Vercel | Settings → Environment Variables |
| Cloudflare Pages | Settings → Environment variables |
| 自托管 | `.env.production` 或系统环境变量 |

::: warning 安全提示
- 不要将 `.env` 文件提交到 Git
- 使用不同的密钥用于开发和生产环境
- 定期更换密钥
:::

## ⚡ 性能优化

### 构建优化

#### 1. 代码分割

Vite 自动进行代码分割，无需额外配置。

#### 2. 压缩

生产构建自动启用压缩：
- `JavaScript` 压缩（Terser）
- `CSS` 压缩（cssnano）

#### 3. Tree Shaking

自动移除未使用的代码。

### CDN 配置

#### 使用 Vercel CDN

Vercel 自动提供全球 `CDN` ，无需配置。

#### 使用 Cloudflare CDN

`Cloudflare Pages` 自动使用 `Cloudflare CDN` 。

#### 自定义 CDN

如果自托管，可以配置 `CDN` ：

```nginx
# 设置缓存头
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header X-Content-Type-Options "nosniff";
}
```

## 📈 监控和日志

### Vercel Analytics

启用 `Vercel Analytics` ：
1. 在项目设置中启用 `Analytics`
2. 查看访问统计和性能指标

### 自定义监控

可以集成第三方监控服务：
- Google Analytics
- Sentry（错误监控）
- LogRocket（用户行为）

## ❓ 常见问题

### Q: 部署后页面空白？

检查：
1. 环境变量是否配置正确
2. 构建是否成功
3. 浏览器控制台是否有错误

### Q: 路由 404 错误？

需要配置 `SPA` 路由重写：
- Vercel：自动配置
- Cloudflare Pages：自动配置
- Nginx：添加 `try_files` 配置

### Q: 环境变量不生效？

确保：
1. 变量名以 `VITE_` 开头
2. 重新构建项目
3. 清除浏览器缓存

### Q: 构建失败？

检查：
1. `Node.js` 版本（需要 >= 18）
2. 依赖是否安装完整
3. 构建日志中的错误信息

### Q: 如何回滚部署？

- Vercel：在 `Deployments` 页面选择之前的部署，点击 `Promote to Production`
- Cloudflare Pages：在 `Deployments` 页面选择之前的部署，点击 `Rollback`
- 自托管：恢复之前的构建产物
