# æ•°æ®åº“å»ºè¡¨

## ğŸ“ æ¦‚è¿°

ValPoint ä½¿ç”¨ Supabase ä½œä¸ºåç«¯ï¼Œé‡‡ç”¨ PostgreSQL æ•°æ®åº“ã€‚æœ¬æ–‡æ¡£æä¾›ä¸€é”®å»ºè¡¨è„šæœ¬ï¼Œå¯å¿«é€Ÿåˆå§‹åŒ–å®Œæ•´çš„æ•°æ®åº“ç»“æ„ã€‚

## ğŸ†• æ–°å»ºSupabaseé¡¹ç›®

<figure class="full-bleed">
  <img class="full-bleed" src="../public/plate/SupaBase-01.jpg" alt="æ–°å»ºé¡¹ç›®" />
  <figcaption>æ–°å»ºé¡¹ç›®</figcaption>
</figure>

<figure class="full-bleed">
  <img class="full-bleed" src="../public/plate/SupaBase-02.jpg" alt="æ–°å»ºé¡¹ç›®" />
  <figcaption>è¦é€‰æ‹© æ–°åŠ å¡ åœ°åŸŸ</figcaption>
</figure>

## ğŸ“Š æ•°æ®åº“æ¶æ„

ç³»ç»ŸåŒ…å« 7 å¼ æ ¸å¿ƒæ•°æ®è¡¨ï¼š

| è¡¨å | ç”¨é€” |
|------|------|
| `user_profiles` | ç”¨æˆ·èµ„æ–™ï¼ˆè§’è‰²ã€æƒé™ã€ä¸‹è½½ç»Ÿè®¡ï¼‰|
| `valorant_lineups` | ä¸ªäººç‚¹ä½åº“ |
| `valorant_shared` | å…±äº«ä¸­å¿ƒåº“ |
| `lineup_submissions` | ç‚¹ä½æŠ•ç¨¿å®¡æ ¸ |
| `user_daily_downloads` | æ¯æ—¥ä¸‹è½½é™åˆ¶ |
| `system_settings` | ç³»ç»Ÿè®¾ç½®ï¼ˆå›¾åºŠã€æŠ•ç¨¿å¼€å…³ï¼‰|
| `download_logs` | ä¸‹è½½æ—¥å¿—è®°å½• |

## ğŸš€ ä¸€é”®å»ºè¡¨è„šæœ¬

> [!TIP]
> ä»¥ä¸‹è„šæœ¬æ˜¯å¹‚ç­‰çš„ï¼Œå¯ä»¥é‡å¤æ‰§è¡Œã€‚åœ¨ Supabase Dashboard â†’ SQL Editor ä¸­æ‰§è¡Œå³å¯ã€‚


::: details ç‚¹å‡»æŸ¥çœ‹å®Œæ•´è„šæœ¬

```sql
-- ==========================================
-- ValPoint Supabase æ•°æ®åº“ä¸€é”®é‡å»ºè„šæœ¬
-- ç‰ˆæœ¬: 2.1 | ä¼˜åŒ–æ—¥æœŸ: 2025-12-29
-- ==========================================
-- ä½¿ç”¨è¯´æ˜:
-- 1. åœ¨ Supabase Dashboard -> SQL Editor ä¸­æ‰§è¡Œæ­¤è„šæœ¬
-- 2. æ‰§è¡Œå‰ç¡®ä¿å·²å¯ç”¨ Email Auth Provider
-- 3. è„šæœ¬æ˜¯å¹‚ç­‰çš„ï¼Œå¯é‡å¤æ‰§è¡Œ
-- ==========================================

-- ==========================================
-- 1. åŸºç¡€æ‰©å±•
-- ==========================================
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- ==========================================
-- 2. é€šç”¨å‡½æ•°
-- ==========================================

-- è‡ªåŠ¨æ›´æ–° updated_at æ—¶é—´æˆ³
CREATE OR REPLACE FUNCTION handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- æ–°ç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨åˆ›å»º user_profiles è®°å½•
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO public.user_profiles (id, email, nickname, custom_id, avatar, role)
    VALUES (
        NEW.id,
        NEW.email,
        COALESCE(NEW.raw_user_meta_data->>'nickname', ''),
        COALESCE(NEW.raw_user_meta_data->>'custom_id', ''),
        COALESCE(NEW.raw_user_meta_data->>'avatar', ''),
        'user'
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- è‡ªåŠ¨ç´¯è®¡ä¸‹è½½æ¬¡æ•°
CREATE OR REPLACE FUNCTION public.increment_user_download_count()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.user_id IS NOT NULL THEN
        UPDATE public.user_profiles
        SET download_count = COALESCE(download_count, 0) + COALESCE(NEW.download_count, 1)
        WHERE id = NEW.user_id;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ç®¡ç†å‘˜æƒé™æ£€æŸ¥å‡½æ•°
CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM public.user_profiles
    WHERE id = auth.uid() AND role IN ('admin', 'super_admin')
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- è·å–ç”¨æˆ·è§’è‰²ï¼ˆé¿å… RLS é€’å½’ï¼‰
CREATE OR REPLACE FUNCTION public.get_user_role(user_id uuid)
RETURNS text
LANGUAGE sql
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT role::text FROM user_profiles WHERE id = user_id;
$$;

-- ==========================================
-- 3. æ•°æ®è¡¨å®šä¹‰
-- ==========================================

-- ç”¨æˆ·èµ„æ–™è¡¨
CREATE TABLE IF NOT EXISTS public.user_profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    email TEXT,
    nickname TEXT,
    avatar TEXT,
    custom_id TEXT UNIQUE,
    role TEXT DEFAULT 'user' CHECK (role IN ('user', 'admin', 'super_admin')),
    is_banned BOOLEAN DEFAULT false,
    ban_reason TEXT,
    download_count BIGINT DEFAULT 0,
    can_batch_download BOOLEAN DEFAULT false,
    pinned_lineup_ids JSONB DEFAULT '[]'::jsonb,
    subscriptions JSONB DEFAULT '[]'::jsonb,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ä¸ªäººç‚¹ä½åº“
CREATE TABLE IF NOT EXISTS public.valorant_lineups (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    title TEXT,
    map_name TEXT,
    agent_name TEXT,
    agent_icon TEXT,
    skill_icon TEXT,
    side TEXT CHECK (side IN ('attack', 'defense')),
    ability_index INTEGER,
    agent_pos JSONB,
    skill_pos JSONB,
    stand_img TEXT,
    stand_desc TEXT,
    stand2_img TEXT,
    stand2_desc TEXT,
    aim_img TEXT,
    aim_desc TEXT,
    aim2_img TEXT,
    aim2_desc TEXT,
    land_img TEXT,
    land_desc TEXT,
    source_link TEXT,
    cloned_from UUID,
    author_name TEXT,
    author_avatar TEXT,
    author_uid TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- å…±äº«ä¸­å¿ƒåº“
CREATE TABLE IF NOT EXISTS public.valorant_shared (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    source_id TEXT,
    title TEXT,
    map_name TEXT,
    agent_name TEXT,
    agent_icon TEXT,
    skill_icon TEXT,
    side TEXT CHECK (side IN ('attack', 'defense')),
    ability_index INTEGER,
    agent_pos JSONB,
    skill_pos JSONB,
    stand_img TEXT,
    stand_desc TEXT,
    stand2_img TEXT,
    stand2_desc TEXT,
    aim_img TEXT,
    aim_desc TEXT,
    aim2_img TEXT,
    aim2_desc TEXT,
    land_img TEXT,
    land_desc TEXT,
    source_link TEXT,
    author_name TEXT,
    author_avatar TEXT,
    author_uid TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç‚¹ä½æŠ•ç¨¿å®¡æ ¸è¡¨
CREATE TABLE IF NOT EXISTS public.lineup_submissions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    submitter_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    submitter_email TEXT,
    title TEXT,
    map_name TEXT,
    agent_name TEXT,
    agent_icon TEXT,
    skill_icon TEXT,
    side TEXT DEFAULT 'attack' CHECK (side IN ('attack', 'defense')),
    ability_index INTEGER,
    agent_pos JSONB,
    skill_pos JSONB,
    description TEXT,
    stand_img TEXT,
    stand_desc TEXT,
    stand2_img TEXT,
    stand2_desc TEXT,
    aim_img TEXT,
    aim_desc TEXT,
    aim2_img TEXT,
    aim2_desc TEXT,
    land_img TEXT,
    land_desc TEXT,
    source_link TEXT,
    author_name TEXT,
    author_avatar TEXT,
    author_uid TEXT,
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
    reject_reason TEXT,
    reviewed_by TEXT,
    reviewed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ¯æ—¥ä¸‹è½½é™åˆ¶è¡¨
CREATE TABLE IF NOT EXISTS public.user_daily_downloads (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    count INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, date)
);

-- ç³»ç»Ÿè®¾ç½®è¡¨
CREATE TABLE IF NOT EXISTS public.system_settings (
    id UUID PRIMARY KEY DEFAULT '00000000-0000-0000-0000-000000000001'::uuid,
    official_oss_config JSONB,
    submission_enabled BOOLEAN DEFAULT true,
    daily_submission_limit INTEGER DEFAULT 10,
    daily_download_limit INTEGER DEFAULT 50,
    author_links JSONB DEFAULT '{
        "github_url": "",
        "tutorial_url": "",
        "donate_wechat_qr": "",
        "donate_alipay_qr": "",
        "contact_wechat_qr": ""
    }'::jsonb,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆå§‹åŒ–ç³»ç»Ÿè®¾ç½®
INSERT INTO public.system_settings (id)
VALUES ('00000000-0000-0000-0000-000000000001')
ON CONFLICT (id) DO NOTHING;

-- ä¸‹è½½æ—¥å¿—è¡¨
CREATE TABLE IF NOT EXISTS public.download_logs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    user_email TEXT,
    lineup_id TEXT,
    lineup_title TEXT,
    map_name TEXT,
    agent_name TEXT,
    download_count INTEGER DEFAULT 1,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ==========================================
-- 4. è§¦å‘å™¨
-- ==========================================

-- æ–°ç”¨æˆ·æ³¨å†Œè§¦å‘å™¨
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- è‡ªåŠ¨æ›´æ–° updated_at è§¦å‘å™¨
DROP TRIGGER IF EXISTS tr_user_profiles_updated_at ON public.user_profiles;
CREATE TRIGGER tr_user_profiles_updated_at BEFORE UPDATE ON public.user_profiles FOR EACH ROW EXECUTE FUNCTION handle_updated_at();

DROP TRIGGER IF EXISTS tr_valorant_lineups_updated_at ON public.valorant_lineups;
CREATE TRIGGER tr_valorant_lineups_updated_at BEFORE UPDATE ON public.valorant_lineups FOR EACH ROW EXECUTE FUNCTION handle_updated_at();

DROP TRIGGER IF EXISTS tr_valorant_shared_updated_at ON public.valorant_shared;
CREATE TRIGGER tr_valorant_shared_updated_at BEFORE UPDATE ON public.valorant_shared FOR EACH ROW EXECUTE FUNCTION handle_updated_at();

DROP TRIGGER IF EXISTS tr_lineup_submissions_updated_at ON public.lineup_submissions;
CREATE TRIGGER tr_lineup_submissions_updated_at BEFORE UPDATE ON public.lineup_submissions FOR EACH ROW EXECUTE FUNCTION handle_updated_at();

DROP TRIGGER IF EXISTS tr_user_daily_downloads_updated_at ON public.user_daily_downloads;
CREATE TRIGGER tr_user_daily_downloads_updated_at BEFORE UPDATE ON public.user_daily_downloads FOR EACH ROW EXECUTE FUNCTION handle_updated_at();

-- ä¸‹è½½æ—¥å¿—è§¦å‘å™¨
DROP TRIGGER IF EXISTS on_download_log_created ON public.download_logs;
CREATE TRIGGER on_download_log_created
    AFTER INSERT ON public.download_logs
    FOR EACH ROW EXECUTE FUNCTION public.increment_user_download_count();

-- ==========================================
-- 5. è¡Œçº§å®‰å…¨ç­–ç•¥ (RLS)
-- ==========================================

-- å¯ç”¨ RLS
ALTER TABLE public.user_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.valorant_lineups ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.valorant_shared ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.lineup_submissions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_daily_downloads ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.system_settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.download_logs ENABLE ROW LEVEL SECURITY;

-- user_profiles ç­–ç•¥
DROP POLICY IF EXISTS "users_select_policy" ON public.user_profiles;
DROP POLICY IF EXISTS "users_update_policy" ON public.user_profiles;
DROP POLICY IF EXISTS "users_insert_policy" ON public.user_profiles;

CREATE POLICY "users_select_policy" ON public.user_profiles FOR SELECT USING (true);
CREATE POLICY "users_insert_policy" ON public.user_profiles FOR INSERT WITH CHECK (auth.uid() = id);
CREATE POLICY "users_update_policy" ON public.user_profiles FOR UPDATE
USING (auth.uid() = id OR public.get_user_role(auth.uid()) IN ('admin', 'super_admin'))
WITH CHECK (auth.uid() = id OR public.get_user_role(auth.uid()) IN ('admin', 'super_admin'));

-- valorant_lineups ç­–ç•¥
DROP POLICY IF EXISTS "Users can view own lineups" ON public.valorant_lineups;
DROP POLICY IF EXISTS "Users can insert own lineups" ON public.valorant_lineups;
DROP POLICY IF EXISTS "Users can update own lineups" ON public.valorant_lineups;
DROP POLICY IF EXISTS "Users can delete own lineups" ON public.valorant_lineups;

CREATE POLICY "Users can view own lineups" ON public.valorant_lineups FOR SELECT TO authenticated USING (user_id = auth.uid());
CREATE POLICY "Users can insert own lineups" ON public.valorant_lineups FOR INSERT TO authenticated WITH CHECK (user_id = auth.uid());
CREATE POLICY "Users can update own lineups" ON public.valorant_lineups FOR UPDATE TO authenticated USING (user_id = auth.uid());
CREATE POLICY "Users can delete own lineups" ON public.valorant_lineups FOR DELETE TO authenticated USING (user_id = auth.uid());

-- valorant_shared ç­–ç•¥
DROP POLICY IF EXISTS "Anyone can view shared lineups" ON public.valorant_shared;
DROP POLICY IF EXISTS "Only admins can modify shared lineups" ON public.valorant_shared;

CREATE POLICY "Anyone can view shared lineups" ON public.valorant_shared FOR SELECT USING (true);
CREATE POLICY "Only admins can modify shared lineups" ON public.valorant_shared FOR ALL TO authenticated USING (public.is_admin());

-- lineup_submissions ç­–ç•¥
DROP POLICY IF EXISTS "Users can view own submissions" ON public.lineup_submissions;
DROP POLICY IF EXISTS "Users can insert own submissions" ON public.lineup_submissions;
DROP POLICY IF EXISTS "Users can update own submissions" ON public.lineup_submissions;
DROP POLICY IF EXISTS "Users can delete own submissions" ON public.lineup_submissions;

CREATE POLICY "Users can view own submissions" ON public.lineup_submissions FOR SELECT TO authenticated
    USING (submitter_id = auth.uid() OR public.is_admin());
CREATE POLICY "Users can insert own submissions" ON public.lineup_submissions FOR INSERT TO authenticated WITH CHECK (submitter_id = auth.uid());
CREATE POLICY "Users can update own submissions" ON public.lineup_submissions FOR UPDATE TO authenticated
    USING (submitter_id = auth.uid() OR public.is_admin());
CREATE POLICY "Users can delete own submissions" ON public.lineup_submissions FOR DELETE TO authenticated USING (submitter_id = auth.uid());

-- user_daily_downloads ç­–ç•¥
DROP POLICY IF EXISTS "Users can view own downloads" ON public.user_daily_downloads;
DROP POLICY IF EXISTS "Users can upsert own downloads" ON public.user_daily_downloads;

CREATE POLICY "Users can view own downloads" ON public.user_daily_downloads FOR SELECT TO authenticated USING (user_id = auth.uid());
CREATE POLICY "Users can upsert own downloads" ON public.user_daily_downloads FOR ALL TO authenticated USING (user_id = auth.uid()) WITH CHECK (user_id = auth.uid());

-- system_settings ç­–ç•¥
DROP POLICY IF EXISTS "Anyone can read system settings" ON public.system_settings;
DROP POLICY IF EXISTS "Only admins can update system settings" ON public.system_settings;

CREATE POLICY "Anyone can read system settings" ON public.system_settings FOR SELECT TO anon, authenticated USING (true);
CREATE POLICY "Only admins can update system settings" ON public.system_settings FOR UPDATE TO authenticated USING (public.is_admin());

-- download_logs ç­–ç•¥
DROP POLICY IF EXISTS "Users can insert own download logs" ON public.download_logs;
DROP POLICY IF EXISTS "Admins can view all download logs" ON public.download_logs;

CREATE POLICY "Users can insert own download logs" ON public.download_logs FOR INSERT TO authenticated WITH CHECK (user_id = auth.uid());
CREATE POLICY "Admins can view all download logs" ON public.download_logs FOR SELECT TO authenticated USING (public.is_admin());

-- ==========================================
-- 6. Storage å­˜å‚¨æ¡¶é…ç½®
-- ==========================================

INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
    'submissions', 
    'submissions', 
    true, 
    8388608, -- 8MB
    ARRAY['image/png', 'image/jpeg', 'image/gif', 'image/webp']::text[]
)
ON CONFLICT (id) DO UPDATE SET
    public = EXCLUDED.public,
    file_size_limit = EXCLUDED.file_size_limit,
    allowed_mime_types = EXCLUDED.allowed_mime_types;

-- Storage RLS ç­–ç•¥
DROP POLICY IF EXISTS "Public Access" ON storage.objects;
CREATE POLICY "Public Access" ON storage.objects FOR SELECT USING (bucket_id = 'submissions');

DROP POLICY IF EXISTS "Auth Upload" ON storage.objects;
CREATE POLICY "Auth Upload" ON storage.objects FOR INSERT TO authenticated WITH CHECK (bucket_id = 'submissions');

DROP POLICY IF EXISTS "Admin Delete" ON storage.objects;
CREATE POLICY "Admin Delete" ON storage.objects FOR DELETE TO authenticated USING (bucket_id = 'submissions' AND public.is_admin());

-- ==========================================
-- 7. ç´¢å¼•ä¼˜åŒ–
-- ==========================================

-- ä¸ªäººåº“ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_valorant_lineups_user_id ON public.valorant_lineups(user_id);
CREATE INDEX IF NOT EXISTS idx_valorant_lineups_map_agent ON public.valorant_lineups(map_name, agent_name);
CREATE INDEX IF NOT EXISTS idx_valorant_lineups_side ON public.valorant_lineups(side);
CREATE INDEX IF NOT EXISTS idx_valorant_lineups_cloned_from ON public.valorant_lineups(cloned_from);

-- å…±äº«åº“ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_valorant_shared_map_agent ON public.valorant_shared(map_name, agent_name);
CREATE INDEX IF NOT EXISTS idx_valorant_shared_source_id ON public.valorant_shared(source_id);
CREATE INDEX IF NOT EXISTS idx_valorant_shared_side ON public.valorant_shared(side);

-- æŠ•ç¨¿å®¡æ ¸ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_lineup_submissions_submitter ON public.lineup_submissions(submitter_id);
CREATE INDEX IF NOT EXISTS idx_lineup_submissions_status ON public.lineup_submissions(status);

-- æ¯æ—¥ä¸‹è½½ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_user_daily_downloads_lookup ON public.user_daily_downloads(user_id, date);

-- ä¸‹è½½æ—¥å¿—ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_download_logs_user_id ON public.download_logs(user_id);
CREATE INDEX IF NOT EXISTS idx_download_logs_created_at ON public.download_logs(created_at DESC);

-- ç”¨æˆ·èµ„æ–™ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_user_profiles_email ON public.user_profiles(email);
CREATE INDEX IF NOT EXISTS idx_user_profiles_custom_id ON public.user_profiles(custom_id);
```

:::

<figure class="full-bleed">
  <img class="full-bleed" src="../public/plate/SQL-Editor-01.jpg" alt="SQL-Editor-01" />
  <figcaption>ç¬¬ä¸€æ­¥</figcaption>
</figure>

<figure class="full-bleed">
  <img class="full-bleed" src="../public/plate/SQL-Editor-02.jpg" alt="SQL-Editor-02" />
  <figcaption>ç¬¬äºŒæ­¥</figcaption>
</figure>

<figure class="full-bleed">
  <img class="full-bleed" src="../public/plate/SQL-Editor-03.jpg" alt="SQL-Editor-03" />
  <figcaption>ç¬¬ä¸‰æ­¥</figcaption>
</figure>

<figure class="full-bleed">
  <img class="full-bleed" src="../public/plate/SQL-Editor-04.jpg" alt="SQL-Editor-04" />
<figcaption>ç¬¬å››æ­¥</figcaption>
</figure>

## âœ… éªŒè¯ç»“æœ

æ‰§è¡Œè„šæœ¬åï¼Œåœ¨ `Table Editor` ä¸­åº”çœ‹åˆ°ä»¥ä¸‹ 7 å¼ è¡¨ï¼š

| è¡¨å | è¯´æ˜ |
|------|------|
| `user_profiles` | ç”¨æˆ·èµ„æ–™ |
| `valorant_lineups` | ä¸ªäººç‚¹ä½ |
| `valorant_shared` | å…±äº«ç‚¹ä½ |
| `lineup_submissions` | æŠ•ç¨¿å®¡æ ¸ |
| `user_daily_downloads` | ä¸‹è½½é™åˆ¶ |
| `system_settings` | ç³»ç»Ÿè®¾ç½® |
| `download_logs` | ä¸‹è½½æ—¥å¿— |

## ğŸ‘‘ æ³¨å†Œè¶…çº§ç®¡ç†å‘˜

> [!IMPORTANT]
> æ‰§è¡Œææƒè„šæœ¬å‰ï¼Œè¯·å…ˆåœ¨ ValPoint ç½‘ç«™å®Œæˆè´¦å·æ³¨å†Œã€‚åªæœ‰å·²æ³¨å†Œçš„ç”¨æˆ·æ‰èƒ½è¢«è®¾ç½®ä¸ºè¶…çº§ç®¡ç†å‘˜ã€‚

åœ¨ SQL Editor ä¸­æ‰§è¡Œä»¥ä¸‹è„šæœ¬ï¼Œå°†æŒ‡å®šé‚®ç®±çš„ç”¨æˆ·ææƒä¸ºè¶…çº§ç®¡ç†å‘˜ï¼š

::: details ç‚¹å‡»æŸ¥çœ‹ææƒè„šæœ¬

```sql
-- è¯·å°† 'your_email@example.com' æ›¿æ¢ä¸ºä½ åˆšåˆšæ³¨å†Œçš„é‚®ç®±
UPDATE public.user_profiles 
SET role = 'super_admin' 
WHERE id = (
    SELECT id 
    FROM auth.users 
    WHERE email = 'your_email@example.com'
);
```

:::

<figure class="full-bleed">
  <img class="full-bleed" src="../public/plate/SQL-Editor-05.jpg" alt="SQL-Editor-05" />
  <figcaption>ç¬¬äº”æ­¥ï¼šæ‰§è¡Œææƒè„šæœ¬</figcaption>
</figure>

::: details éªŒè¯ææƒç»“æœï¼ˆå¯é€‰ï¼‰

```sql
SELECT auth.users.email, user_profiles.role 
FROM user_profiles 
JOIN auth.users ON user_profiles.id = auth.users.id 
WHERE auth.users.email = 'your_email@example.com';
```

:::

<figure class="full-bleed">
  <img class="full-bleed" src="../public/plate/SQL-Editor-06.jpg" alt="SQL-Editor-06" />
  <figcaption>ç¬¬å…­æ­¥ï¼šéªŒè¯ææƒç»“æœ</figcaption>
</figure>

## ğŸ”§ Edge Functions

åœ¨ `Supabase Dashboard` â†’ `Edge Functions` ä¸­åˆ›å»º `get-video-author` å‡½æ•°ï¼š

::: details ç‚¹å‡»æŸ¥çœ‹ Edge Function ä»£ç 

```typescript
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

// æŠ–éŸ³ HTML æ¸…æ´—å‡½æ•°
function cleanHtml(text: string) {
  let decoded = text
    .replace(/\\u002F/g, "/")
    .replace(/\\u0026/g, "&")
    .replace(/\\"/g, '"')
    .replace(/&quot;/g, '"')
    .replace(/&amp;/g, '&')
    .replace(/\\\//g, '/');
  try { decoded = decodeURIComponent(decoded); } catch (e) {}
  return decoded;
}

// Bilibili è§£æ
async function handleBilibili(targetUrl: string) {
  const bvMatch = targetUrl.match(/(BV[a-zA-Z0-9]+)/)
  if (!bvMatch) throw new Error("æœªæ‰¾åˆ°æœ‰æ•ˆçš„ BV å·")
  
  const bvid = bvMatch[1]
  const apiUrl = `https://api.bilibili.com/x/web-interface/view?bvid=${bvid}`
  const headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
    "Referer": "https://www.bilibili.com/"
  }

  const response = await fetch(apiUrl, { headers })
  const json = await response.json()

  if (json.code === 0 && json.data) {
    const owner = json.data.owner
    return {
      username: owner.name,
      avatar: owner.face,
      user_home_url: `https://space.bilibili.com/${owner.mid}`,
      is_cover: false,
      source: "bilibili",
      cover_image: json.data.pic
    }
  } else {
    throw new Error(`Bç«™ API æŠ¥é”™: ${json.message}`)
  }
}

// æŠ–éŸ³è§£æ
async function handleDouyin(targetUrl: string) {
  const headers = {
    "User-Agent": "Mozilla/5.0 (iPad; CPU OS 13_3 like Mac OS X)",
    "Referer": "https://www.douyin.com/"
  }

  const response = await fetch(targetUrl, { headers })
  const html = cleanHtml(await response.text())

  let nickname = "", avatar = "", sec_uid = ""
  
  // æå–ç”¨æˆ·ä¸»é¡µ
  const linkMatch = html.match(/href=["']\/\/www\.douyin\.com\/user\/(MS4wLjABAAAA[A-Za-z0-9_\\-]+)["']/)
  if (linkMatch) sec_uid = linkMatch[1]
  
  // æå–å¤´åƒ
  const avatarMatch = html.match(/"url_list":\["(https:\/\/[^"]*?aweme-avatar[^"]*?)"/)
  if (avatarMatch) avatar = avatarMatch[1]
  
  // æå–ç”¨æˆ·å
  const titleMatch = html.match(/<title>(.*?)[\s-]*æŠ–éŸ³/)
  if (titleMatch) nickname = titleMatch[1].trim()

  return {
    username: nickname || "æœªæå–åˆ°",
    avatar: avatar || "",
    user_home_url: sec_uid ? `https://www.douyin.com/user/${sec_uid}` : "",
    is_cover: false,
    source: "douyin"
  }
}

// ä¸»å…¥å£
serve(async (req) => {
  if (req.method === 'OPTIONS') return new Response('ok', { headers: corsHeaders })

  try {
    const body = await req.json()
    const urlText = body.url || ""
    if (!urlText) throw new Error("ç¼ºå°‘ URL å‚æ•°")

    const douyinRegex = /(https?:\/\/(?:v|www|m)\.douyin\.com\/[^\s"']+)/
    const biliRegex = /(https?:\/\/(?:www|m)\.bilibili\.com\/video\/[^\s"']+)|(https?:\/\/b23\.tv\/[^\s"']+)/

    let result;
    const matchDouyin = urlText.match(douyinRegex)
    const matchBili = urlText.match(biliRegex)

    if (matchDouyin) {
      result = await handleDouyin(matchDouyin[0])
    } else if (matchBili) {
      let finalUrl = matchBili[0]
      if (finalUrl.includes("b23.tv")) {
        const r = await fetch(finalUrl, { redirect: 'follow' })
        finalUrl = r.url
      }
      result = await handleBilibili(finalUrl)
    } else {
      throw new Error("æ— æ•ˆé“¾æ¥ï¼šæœªè¯†åˆ«åˆ° æŠ–éŸ³ æˆ– Bç«™ é“¾æ¥")
    }

    return new Response(
      JSON.stringify({ status: "success", data: result }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" } }
    )

  } catch (error) {
    return new Response(
      JSON.stringify({ error: error.message }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" }, status: 400 }
    )
  }
})
```

:::

<figure class="full-bleed">
  <img class="full-bleed" src="../public/plate/Edge-Functions-01.jpg" alt="Edge-Functions-01" />
  <figcaption>ç¬¬ä¸€æ­¥</figcaption>
</figure>

<figure class="full-bleed">
  <img class="full-bleed" src="../public/plate/Edge-Functions-02.jpg" alt="Edge-Functions-02" />
  <figcaption>ç¬¬äºŒæ­¥</figcaption>
</figure>

<figure class="full-bleed">
  <img class="full-bleed" src="../public/plate/Edge-Functions-03.jpg" alt="Edge-Functions-03" />
  <figcaption>ç¬¬ä¸‰æ­¥</figcaption>
</figure>

``` json
{ "url": "ã€ã€ŠèŠ±æµ·ã€‹é­”æ³•é’¢ç´ç‰ˆã€‘ ã€ç²¾å‡†ç©ºé™åˆ° 01:32ã€‘ https://www.bilibili.com/video/BV19QiFB5EMC/?share_source=copy_web&vd_source=fd59995bf2f70580369462145819da94&t=92" }

```

<figure class="full-bleed">
  <img class="full-bleed" src="../public/plate/Edge-Functions-04.jpg" alt="Edge-Functions-04" />
  <figcaption>ç¬¬å››æ­¥:éªŒè¯æ˜¯å¦æœ‰æ•ˆ</figcaption>
</figure>

<figure class="full-bleed">
  <img class="full-bleed" src="../public/plate/Edge-Functions-05.jpg" alt="Edge-Functions-05" />
  <figcaption>ç¬¬äº”æ­¥</figcaption>
</figure>


