# ä½œè€…ä¿¡æ¯è§£æ

ä½œè€…ä¿¡æ¯è‡ªåŠ¨è·å–æ˜¯ `ValPoint` çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œæ”¯æŒä» B ç«™å’ŒæŠ–éŸ³è§†é¢‘é“¾æ¥è‡ªåŠ¨è§£æä½œè€…ä¿¡æ¯ã€‚

## ğŸ—ï¸ æŠ€æœ¯æ–¹æ¡ˆ

### æ¶æ„è®¾è®¡

```
å‰ç«¯ (Browser)
    â”‚
    â”‚ 1. ç”¨æˆ·è¾“å…¥è§†é¢‘é“¾æ¥
    â–¼
authorFetcher.ts
    â”‚
    â”‚ 2. è°ƒç”¨ Edge Function
    â–¼
Supabase Edge Function
(get-video-author)
    â”‚
    â”‚ 3. æœåŠ¡ç«¯è¯·æ±‚
    â–¼
B ç«™ / æŠ–éŸ³ API
    â”‚
    â”‚ 4. è¿”å› HTML/JSON
    â–¼
è§£æé€»è¾‘
    â”‚
    â”‚ 5. æå–ä½œè€…ä¿¡æ¯
    â–¼
è¿”å›å‰ç«¯
    â”‚
    â”‚ 6. æ˜¾ç¤ºä½œè€…ä¿¡æ¯
    â–¼
ç”¨æˆ·ç•Œé¢
```

### ä¸ºä»€ä¹ˆéœ€è¦ Edge Functionï¼Ÿ

#### é—®é¢˜

1. **CORS é™åˆ¶**
   - B ç«™å’ŒæŠ–éŸ³çš„ `API` ä¸å…è®¸è·¨åŸŸè¯·æ±‚
   - æµè§ˆå™¨ä¼šé˜»æ­¢ç›´æ¥è¯·æ±‚

2. **åçˆ¬è™«æœºåˆ¶**
   - éœ€è¦ç‰¹å®šçš„ `User-Agent`
   - éœ€è¦ `Referer` å¤´
   - å¯èƒ½éœ€è¦ `Cookie`

3. **IP é™åˆ¶**
   - é¢‘ç¹è¯·æ±‚å¯èƒ½è¢«å° `IP`
   - éœ€è¦æœåŠ¡ç«¯ä»£ç†

#### è§£å†³æ–¹æ¡ˆ

ä½¿ç”¨ `Supabase Edge Function` ä½œä¸ºä»£ç†ï¼š
- ç»•è¿‡ `CORS` é™åˆ¶
- ä¼ªè£… `User-Agent`
- æœåŠ¡ç«¯è¯·æ±‚ï¼Œä¸å—æµè§ˆå™¨é™åˆ¶

## ğŸ’» å‰ç«¯å®ç°

### authorFetcher.ts

```typescript
// src/utils/authorFetcher.ts

export type AuthorInfo = {
  name: string;           // ä½œè€…æ˜µç§°
  avatar: string;         // å¤´åƒ URL
  uid?: string;           // ç”¨æˆ· ID
  homeUrl?: string;       // ä¸»é¡µé“¾æ¥
  coverImage?: string;    // è§†é¢‘å°é¢ï¼ˆä»… B ç«™ï¼‰
  isCover?: boolean;      // æ˜¯å¦ä½¿ç”¨å°é¢ä»£æ›¿å¤´åƒ
  source?: 'bilibili' | 'douyin';
};

// Edge Function å“åº”ç±»å‹
interface EdgeFunctionResponse {
  status: 'success' | 'error';
  data?: {
    username: string;
    avatar: string;
    user_home_url: string;
    is_cover: boolean;
    source: 'bilibili' | 'douyin';
    cover_image?: string;
  };
  message?: string;
  error?: string;
}

export async function fetchAuthorInfo(
  sourceLink: string
): Promise<AuthorInfo | null> {
  try {
    const url = new URL(sourceLink);
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºæ”¯æŒçš„å¹³å°
    if (
      !url.hostname.includes('bilibili.com') && 
      !url.hostname.includes('douyin.com') && 
      !url.hostname.includes('b23.tv')
    ) {
      return null;
    }
    
    // ä½¿ç”¨ç»Ÿä¸€çš„ Edge Function
    return await fetchAuthorViaEdgeFunction(sourceLink);
  } catch (error) {
    console.error('è·å–ä½œè€…ä¿¡æ¯å¤±è´¥:', error);
    return null;
  }
}

async function fetchAuthorViaEdgeFunction(
  url: string
): Promise<AuthorInfo | null> {
  try {
    const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
    const SUPABASE_ANON_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;
    
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
      console.error('Supabase é…ç½®ç¼ºå¤±');
      return null;
    }
    
    // è°ƒç”¨ Edge Function
    const response = await fetch(
      `${SUPABASE_URL}/functions/v1/get-video-author`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        },
        body: JSON.stringify({ url }),
      }
    );

    if (!response.ok) {
      const errorText = await response.text();
      console.error(`Edge Function é”™è¯¯ ${response.status}:`, errorText);
      return null;
    }

    const result: EdgeFunctionResponse = await response.json();
    
    // å¤„ç†é”™è¯¯å“åº”
    if (result.status === 'error' || result.error) {
      console.error('è·å–ä½œè€…ä¿¡æ¯å¤±è´¥:', result.message || result.error);
      return null;
    }
    
    if (result.status === 'success' && result.data) {
      // æå–ç”¨æˆ· ID
      let uid: string | undefined;
      
      if (result.data.source === 'bilibili') {
        // B ç«™ï¼šä»ä¸»é¡µé“¾æ¥æå– mid
        const midMatch = result.data.user_home_url.match(
          /space\.bilibili\.com\/(\d+)/
        );
        uid = midMatch ? midMatch[1] : undefined;
      } else if (result.data.source === 'douyin') {
        // æŠ–éŸ³ï¼šä»ä¸»é¡µé“¾æ¥æå– sec_uid
        const secUidMatch = result.data.user_home_url.match(
          /\/user\/(MS4wLjABAAAA[A-Za-z0-9_\-]+)/
        );
        uid = secUidMatch ? secUidMatch[1] : undefined;
      }
      
      return {
        name: result.data.username,
        avatar: result.data.avatar,
        uid,
        homeUrl: result.data.user_home_url,
        coverImage: result.data.cover_image,
        isCover: result.data.is_cover,
        source: result.data.source,
      };
    }
    
    return null;
  } catch (error) {
    console.error('è°ƒç”¨ Edge Function å¤±è´¥:', error);
    return null;
  }
}
```

### ç»„ä»¶é›†æˆ

#### EditorModal.tsx

```typescript
// è‡ªåŠ¨è·å–æœºåˆ¶ï¼ˆé˜²æŠ–ï¼‰
useEffect(() => {
  const link = newLineupData.sourceLink?.trim();

  if (fetchTimeoutRef.current) {
    clearTimeout(fetchTimeoutRef.current);
  }

  if (!link || newLineupData.authorName) {
    return;
  }

  // 1 ç§’é˜²æŠ–
  fetchTimeoutRef.current = setTimeout(async () => {
    try {
      setIsFetchingAuthor(true);
      const authorInfo = await fetchAuthorInfo(link);

      if (authorInfo) {
        setNewLineupData((prev) => ({
          ...prev,
          authorName: authorInfo.name,
          authorAvatar: authorInfo.avatar,
          authorUid: authorInfo.uid || '',
        }));
      }
    } catch (error) {
      console.error('è‡ªåŠ¨è·å–ä½œè€…ä¿¡æ¯å¤±è´¥:', error);
    } finally {
      setIsFetchingAuthor(false);
    }
  }, 1000);

  return () => {
    if (fetchTimeoutRef.current) {
      clearTimeout(fetchTimeoutRef.current);
    }
  };
}, [newLineupData.sourceLink, setNewLineupData]);

// æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®
<button
  type="button"
  onClick={async () => {
    const link = newLineupData.sourceLink?.trim();
    if (!link) {
      setAlertMessage?.('è¯·å…ˆè¾“å…¥æ¥æºé“¾æ¥');
      return;
    }
    try {
      setIsFetchingAuthor(true);
      const authorInfo = await fetchAuthorInfo(link);
      if (authorInfo) {
        setNewLineupData((prev) => ({
          ...prev,
          authorName: authorInfo.name,
          authorAvatar: authorInfo.avatar,
          authorUid: authorInfo.uid || '',
        }));
        setAlertMessage?.('ä½œè€…ä¿¡æ¯å·²æ›´æ–°');
      } else {
        setAlertMessage?.('æ— æ³•è·å–ä½œè€…ä¿¡æ¯');
      }
    } catch (error) {
      console.error('æ‰‹åŠ¨åˆ·æ–°ä½œè€…ä¿¡æ¯å¤±è´¥:', error);
      setAlertMessage?.('è·å–ä½œè€…ä¿¡æ¯å¤±è´¥');
    } finally {
      setIsFetchingAuthor(false);
    }
  }}
  disabled={isFetchingAuthor || !newLineupData.sourceLink?.trim()}
>
  <Icon name="RefreshCw" className={isFetchingAuthor ? 'animate-spin' : ''} />
  {isFetchingAuthor ? 'è·å–ä¸­...' : 'æ‰‹åŠ¨åˆ·æ–°'}
</button>
```

#### ViewerModal.tsx

```typescript
// è‡ªåŠ¨è·å–ï¼ˆå¦‚æœæœªä¿å­˜ï¼‰
useEffect(() => {
  if (!viewingLineup?.sourceLink) {
    setAuthorInfo(null);
    setIsLoadingAuthor(false);
    return;
  }

  // å¦‚æœå·²æœ‰ä½œè€…ä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨
  if (viewingLineup?.authorName && viewingLineup?.authorAvatar) {
    setAuthorInfo({
      name: viewingLineup.authorName,
      avatar: viewingLineup.authorAvatar,
      uid: viewingLineup.authorUid || undefined,
    });
    return;
  }

  // å¦åˆ™è‡ªåŠ¨è·å–
  setIsLoadingAuthor(true);
  fetchAuthorInfo(viewingLineup.sourceLink)
    .then((info) => {
      if (info) setAuthorInfo(info);
    })
    .finally(() => setIsLoadingAuthor(false));
}, [viewingLineup]);

// æ˜¾ç¤ºä½œè€…ä¿¡æ¯
{authorInfo && viewingLineup.sourceLink && (
  authorInfo.uid ? (
    <a
      href={
        authorInfo.uid.startsWith('MS4') 
          ? `https://www.douyin.com/user/${authorInfo.uid}` 
          : `https://space.bilibili.com/${authorInfo.uid}`
      }
      target="_blank"
      rel="noopener noreferrer"
    >
      <img 
        src={authorInfo.avatar} 
        referrerPolicy="no-referrer"  // ğŸ”¥ é˜²ç›—é“¾
        alt={authorInfo.name}
      />
      <span>{authorInfo.name}</span>
    </a>
  ) : (
    <div>
      <img 
        src={authorInfo.avatar} 
        referrerPolicy="no-referrer"  // ğŸ”¥ é˜²ç›—é“¾
        alt={authorInfo.name}
      />
      <span>{authorInfo.name}</span>
    </div>
  )
)}
```

## âš™ï¸ åç«¯å®ç°

### Edge Function ç»“æ„

```
supabase/functions/get-video-author/
â”œâ”€â”€ index.ts          # ä¸»å…¥å£
â”œâ”€â”€ bilibili.ts       # B ç«™è§£æé€»è¾‘
â””â”€â”€ douyin.ts         # æŠ–éŸ³è§£æé€»è¾‘
```

### index.ts

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { fetchBilibiliAuthor } from './bilibili.ts';
import { fetchDouyinAuthor } from './douyin.ts';

serve(async (req) => {
  // å¤„ç† CORS
  if (req.method === 'OPTIONS') {
    return new Response(null, {
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'POST, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type, Authorization',
      },
    });
  }

  try {
    if (req.method !== 'POST') {
      return new Response(
        JSON.stringify({ status: 'error', message: 'åªæ”¯æŒ POST è¯·æ±‚' }),
        { status: 405, headers: { 'Content-Type': 'application/json' } }
      );
    }

    const { url } = await req.json();

    if (!url || typeof url !== 'string') {
      return new Response(
        JSON.stringify({ status: 'error', message: 'ç¼ºå°‘ url å‚æ•°' }),
        { status: 400, headers: { 'Content-Type': 'application/json' } }
      );
    }

    // åˆ¤æ–­å¹³å°å¹¶è°ƒç”¨å¯¹åº”çš„å¤„ç†å‡½æ•°
    let authorData = null;

    if (url.includes('bilibili.com') || url.includes('b23.tv')) {
      authorData = await fetchBilibiliAuthor(url);
    } else if (url.includes('douyin.com')) {
      authorData = await fetchDouyinAuthor(url);
    } else {
      return new Response(
        JSON.stringify({ status: 'error', message: 'ä¸æ”¯æŒçš„å¹³å°' }),
        { status: 400, headers: { 'Content-Type': 'application/json' } }
      );
    }

    if (!authorData) {
      return new Response(
        JSON.stringify({ status: 'error', message: 'æ— æ³•è·å–ä½œè€…ä¿¡æ¯' }),
        { status: 404, headers: { 'Content-Type': 'application/json' } }
      );
    }

    return new Response(
      JSON.stringify({ status: 'success', data: authorData }),
      { status: 200, headers: { 'Content-Type': 'application/json' } }
    );
  } catch (error) {
    console.error('å¤„ç†è¯·æ±‚æ—¶å‡ºé”™:', error);
    
    return new Response(
      JSON.stringify({
        status: 'error',
        message: error instanceof Error ? error.message : 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      }),
      { status: 500, headers: { 'Content-Type': 'application/json' } }
    );
  }
});
```

### bilibili.ts

```typescript
export interface BilibiliAuthorData {
  username: string;
  avatar: string;
  user_home_url: string;
  is_cover: boolean;
  source: 'bilibili';
  cover_image?: string;
}

function fixBilibiliAvatar(avatar: string): string {
  if (avatar.startsWith('//')) {
    return 'https:' + avatar;
  }
  if (avatar.startsWith('http://')) {
    return avatar.replace('http://', 'https://');
  }
  return avatar;
}

export async function fetchBilibiliAuthor(
  url: string
): Promise<BilibiliAuthorData | null> {
  try {
    // æå– BV å·
    const bvMatch = url.match(/BV[\w]+/);
    if (!bvMatch) {
      return null;
    }

    const bvid = bvMatch[0];
    const apiUrl = `https://api.bilibili.com/x/web-interface/view?bvid=${bvid}`;
    
    const response = await fetch(apiUrl, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
        'Referer': 'https://www.bilibili.com',
      },
    });
    
    const data = await response.json();
    
    if (data.code === 0 && data.data && data.data.owner) {
      const mid = data.data.owner.mid;
      const coverImage = data.data.pic ? fixBilibiliAvatar(data.data.pic) : undefined;
      
      return {
        username: data.data.owner.name,
        avatar: fixBilibiliAvatar(data.data.owner.face),
        user_home_url: `https://space.bilibili.com/${mid}`,
        is_cover: false,
        source: 'bilibili',
        cover_image: coverImage,
      };
    }
    
    return null;
  } catch (error) {
    console.error('è·å– B ç«™ä½œè€…ä¿¡æ¯å¤±è´¥:', error);
    throw error;
  }
}
```

## ğŸ”’ é˜²ç›—é“¾å¤„ç†

### é—®é¢˜

B ç«™å’ŒæŠ–éŸ³çš„å›¾ç‰‡æœåŠ¡å™¨å¼€å¯äº† `Referer` éªŒè¯ï¼š
- ç›´æ¥åŠ è½½å›¾ç‰‡ä¼šè¿”å› `403 Forbidden`
- æµè§ˆå™¨ä¼šé˜»æ­¢è·¨åŸŸå›¾ç‰‡åŠ è½½

### è§£å†³æ–¹æ¡ˆ

åœ¨æ‰€æœ‰ `<img>` æ ‡ç­¾æ·»åŠ  `referrerPolicy="no-referrer"`ï¼š

```tsx
<img 
  src={authorInfo.avatar} 
  referrerPolicy="no-referrer"  // ğŸ”¥ å…³é”®
  alt={authorInfo.name}
/>
```

### åŸç†

- `referrerPolicy="no-referrer"` å‘Šè¯‰æµè§ˆå™¨ä¸å‘é€ `Referer` å¤´
- å›¾ç‰‡æœåŠ¡å™¨æ— æ³•åˆ¤æ–­æ¥æºï¼Œå…è®¸åŠ è½½
- ä¸å½±å“å›¾ç‰‡æ˜¾ç¤º

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. é˜²æŠ–æœºåˆ¶

```typescript
// 1 ç§’é˜²æŠ–ï¼Œé¿å…é¢‘ç¹è°ƒç”¨
fetchTimeoutRef.current = setTimeout(async () => {
  const authorInfo = await fetchAuthorInfo(link);
  // ...
}, 1000);
```

### 2. ç¼“å­˜ç­–ç•¥

```typescript
// å¦‚æœå·²æœ‰ä½œè€…ä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨
if (viewingLineup?.authorName && viewingLineup?.authorAvatar) {
  setAuthorInfo({
    name: viewingLineup.authorName,
    avatar: viewingLineup.authorAvatar,
    uid: viewingLineup.authorUid,
  });
  return;
}
```

### 3. é”™è¯¯å¤„ç†

```typescript
try {
  const authorInfo = await fetchAuthorInfo(link);
  // ...
} catch (error) {
  console.error('è·å–ä½œè€…ä¿¡æ¯å¤±è´¥:', error);
  // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ç”¨æˆ·æ“ä½œ
  return null;
}
```

## ğŸ§ª æµ‹è¯•

### å•å…ƒæµ‹è¯•

```typescript
describe('authorFetcher', () => {
  it('should extract bilibili author info', async () => {
    const url = 'https://www.bilibili.com/video/BV19rmoBqEdK/';
    const info = await fetchAuthorInfo(url);
    
    expect(info).not.toBeNull();
    expect(info?.name).toBe('è˜…é²¼');
    expect(info?.source).toBe('bilibili');
  });

  it('should return null for invalid url', async () => {
    const url = 'https://example.com';
    const info = await fetchAuthorInfo(url);
    
    expect(info).toBeNull();
  });
});
```

### é›†æˆæµ‹è¯•

```bash
# æµ‹è¯• Edge Function
curl -X POST https://[PROJECT_ID].supabase.co/functions/v1/get-video-author \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer [ANON_KEY]" \
  -d '{"url":"https://www.bilibili.com/video/BV19rmoBqEdK/"}'
```

## â“ å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨å‰ç«¯è¯·æ±‚ï¼Ÿ

**A:** CORS é™åˆ¶å’Œåçˆ¬è™«æœºåˆ¶ã€‚æµè§ˆå™¨ä¼šé˜»æ­¢è·¨åŸŸè¯·æ±‚ã€‚

### Q: Edge Function ä¼šå¢åŠ å»¶è¿Ÿå—ï¼Ÿ

**A:** ä¼šæœ‰ä¸€å®šå»¶è¿Ÿï¼ˆé€šå¸¸ < 1 ç§’ï¼‰ï¼Œä½†å¯ä»¥æ¥å—ã€‚ä½¿ç”¨é˜²æŠ–å’Œç¼“å­˜å¯ä»¥ä¼˜åŒ–ä½“éªŒã€‚

### Q: å¦‚ä½•å¤„ç† API å˜åŒ–ï¼Ÿ

**A:** 
1. ç›‘æ§é”™è¯¯æ—¥å¿—
2. åŠæ—¶æ›´æ–°è§£æé€»è¾‘
3. æ·»åŠ é™çº§æ–¹æ¡ˆï¼ˆä½¿ç”¨å°é¢å›¾ï¼‰

### Q: æ”¯æŒå…¶ä»–å¹³å°å—ï¼Ÿ

**A:** ç›®å‰ä»…æ”¯æŒ B ç«™å’ŒæŠ–éŸ³ã€‚æ·»åŠ æ–°å¹³å°éœ€è¦ï¼š
1. ç ”ç©¶å¹³å° API
2. å®ç°è§£æé€»è¾‘
3. æ›´æ–° `Edge Function`


<!--
## âš¡ æœªæ¥ä¼˜åŒ–

- [ ] æ·»åŠ ç¼“å­˜å±‚ï¼ˆRedisï¼‰
- [ ] æ”¯æŒæ›´å¤šå¹³å°ï¼ˆYouTubeã€TikTokï¼‰
- [ ] æ‰¹é‡è·å–ä½œè€…ä¿¡æ¯
- [ ] å®æ—¶æ›´æ–°ä½œè€…ä¿¡æ¯
- [ ] AI è¯†åˆ«è§†é¢‘å†…å®¹
-->
