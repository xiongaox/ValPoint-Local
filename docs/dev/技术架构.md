# æŠ€æœ¯æ¶æ„

ValPoint é‡‡ç”¨ç°ä»£åŒ–çš„å‰åç«¯åˆ†ç¦»æ¶æ„ï¼ŒåŸºäº `React + Supabase` æ„å»ºã€‚

## ğŸ—ï¸ å‰ç«¯æ¶æ„
### æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| React | 18.x | UI æ¡†æ¶ |
| TypeScript | 5.x | ç±»å‹ç³»ç»Ÿ |
| Vite | 5.x | æ„å»ºå·¥å…· |
| VitePress | 1.x | æ–‡æ¡£ç³»ç»Ÿ |
| Tailwind CSS | 3.x | æ ·å¼æ¡†æ¶ |
| Leaflet | 1.9.x | åœ°å›¾åº“ |
| Lucide React | - | å›¾æ ‡åº“ |

### ç›®å½•ç»“æ„

> ä»¥ä¸‹ä¸ºæ ¸å¿ƒç›®å½•æ¦‚è§ˆï¼Œå®Œæ•´ç»“æ„è¯·å‚è€ƒæºç ã€‚

```
src/
â”œâ”€â”€ apps/                # MPA åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ admin/           # ç®¡ç†åå°
â”‚   â”œâ”€â”€ shared/          # å…±äº«åº“ï¼ˆé¦–é¡µï¼‰
â”‚   â””â”€â”€ user/            # ä¸ªäººåº“
â”‚
â”œâ”€â”€ features/            # åŠŸèƒ½æ¨¡å—
â”‚   â””â”€â”€ lineups/         # ç‚¹ä½ç®¡ç†æ ¸å¿ƒåŠŸèƒ½
â”‚
â”œâ”€â”€ components/          # é€šç”¨ React ç»„ä»¶ (31+)
â”‚   â”œâ”€â”€ AlertModal.tsx   # é€šç”¨å¼¹çª—
â”‚   â”œâ”€â”€ Icon.tsx         # å›¾æ ‡ç»„ä»¶
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ hooks/               # è‡ªå®šä¹‰ Hooks (14+)
â”‚   â”œâ”€â”€ useValorantData.ts
â”‚   â”œâ”€â”€ useLineups.ts
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ lib/                 # åº“å°è£… (21+)
â”‚   â”œâ”€â”€ supabaseClient.ts
â”‚   â”œâ”€â”€ imageBed.ts
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ services/            # æœåŠ¡å±‚
â”œâ”€â”€ types/               # TypeScript ç±»å‹
â”œâ”€â”€ utils/               # å·¥å…·å‡½æ•°
â”œâ”€â”€ constants/           # å¸¸é‡é…ç½®
â”œâ”€â”€ data/                # é™æ€æ•°æ®
â”œâ”€â”€ styles/              # æ ·å¼æ–‡ä»¶
â”‚
â”œâ”€â”€ main.tsx             # ä¸»å…¥å£
â””â”€â”€ index.css            # å…¨å±€æ ·å¼
```

### ç»„ä»¶å±‚æ¬¡

> é¡¹ç›®é‡‡ç”¨ MPA æ¶æ„ï¼Œä¸‰ä¸ªç‹¬ç«‹åº”ç”¨å…±äº«é€šç”¨ç»„ä»¶ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MPA å…¥å£                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ index.html   â”‚ user.html     â”‚ admin.html           â”‚
â”‚ (å…±äº«åº“)     â”‚ (ä¸ªäººåº“)      â”‚ (ç®¡ç†åå°)           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚               â”‚                  â”‚
       â–¼               â–¼                  â–¼
  SharedMainView   UserMainView     AdminLayout
       â”‚               â”‚                  â”‚
       â–¼               â–¼                  â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚              é€šç”¨ç»„ä»¶å±‚                     â”‚
  â”‚  LeafletMap / ViewerModal / EditorModal   â”‚
  â”‚  Icon / AlertModal / AuthorLinksBar       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### VitePress æ–‡æ¡£ç³»ç»Ÿ

é¡¹ç›®å†…ç½®äº†åŸºäº VitePress çš„æ–‡æ¡£ç³»ç»Ÿï¼Œä¸ä¸»åº”ç”¨ç»Ÿä¸€éƒ¨ç½²ã€‚

#### ç›®å½•ç»“æ„

```
docs/
â”œâ”€â”€ .vitepress/
â”‚   â”œâ”€â”€ config.ts        # VitePress é…ç½®
â”‚   â””â”€â”€ theme/           # è‡ªå®šä¹‰ä¸»é¢˜
â”œâ”€â”€ guide/               # ç”¨æˆ·æŒ‡å—
â”œâ”€â”€ dev/                 # å¼€å‘æ–‡æ¡£
â”œâ”€â”€ public/              # é™æ€èµ„æº
â””â”€â”€ index.md             # æ–‡æ¡£é¦–é¡µ
```

#### æ„å»ºæµç¨‹

```bash
# å¼€å‘ç¯å¢ƒï¼ˆéœ€åŒæ—¶è¿è¡Œï¼‰
npm run dev         # ä¸»åº”ç”¨ localhost:3208
npm run docs:dev    # VitePress localhost:5173

# ç”Ÿäº§æ„å»ºï¼ˆç»Ÿä¸€æ„å»ºè„šæœ¬ï¼‰
npm run build:all   # ä¸»åº”ç”¨ + æ–‡æ¡£ä¸€èµ·æ„å»º
```

#### è®¿é—®è·¯å¾„

| ç¯å¢ƒ | è®¿é—®æ–¹å¼ |
|------|---------|
| å¼€å‘ | `localhost:3208/wiki/` (é€šè¿‡ Vite ä»£ç†) |
| ç”Ÿäº§ | `yoursite.com/wiki/` (é™æ€æ–‡ä»¶) |

#### æŠ€æœ¯è¦ç‚¹

- **Base è·¯å¾„**: VitePress é…ç½® `base: '/wiki/'`
- **ä»£ç†é…ç½®**: Vite å¼€å‘æœåŠ¡å™¨ä»£ç† `/wiki/*` åˆ° VitePress
- **æ„å»ºåˆå¹¶**: `build-all.js` å°† VitePress è¾“å‡ºå¤åˆ¶åˆ° `dist/wiki/`

## ğŸ—ï¸ åç«¯æ¶æ„

### Supabase æœåŠ¡

#### PostgreSQL æ•°æ®åº“

ç³»ç»Ÿä½¿ç”¨ 7 å¼ æ ¸å¿ƒæ•°æ®è¡¨ï¼š

| è¡¨å | ç”¨é€” |
|------|------|
| `user_profiles` | ç”¨æˆ·èµ„æ–™ï¼ˆè§’è‰²ã€æƒé™ã€ä¸‹è½½ç»Ÿè®¡ï¼‰|
| `valorant_lineups` | ä¸ªäººç‚¹ä½åº“ |
| `valorant_shared` | å…±äº«ä¸­å¿ƒåº“ |
| `lineup_submissions` | ç‚¹ä½æŠ•ç¨¿å®¡æ ¸ |
| `user_daily_downloads` | æ¯æ—¥ä¸‹è½½é™åˆ¶ |
| `system_settings` | ç³»ç»Ÿè®¾ç½®ï¼ˆå›¾åºŠã€æŠ•ç¨¿å¼€å…³ï¼‰|
| `download_logs` | ä¸‹è½½æ—¥å¿—è®°å½• |

**ç”¨æˆ·èµ„æ–™è¡¨ (user_profiles)**

```sql
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  email TEXT,
  nickname TEXT,
  avatar TEXT,
  custom_id TEXT UNIQUE,                    -- è‡ªå®šä¹‰ç”¨æˆ· ID
  role TEXT CHECK (role IN ('user', 'admin', 'super_admin')),
  is_banned BOOLEAN DEFAULT false,
  ban_reason TEXT,
  download_count BIGINT DEFAULT 0,          -- ç´¯è®¡ä¸‹è½½æ¬¡æ•°
  can_batch_download BOOLEAN DEFAULT false, -- æ‰¹é‡ä¸‹è½½æƒé™
  pinned_lineup_ids JSONB DEFAULT '[]',     -- ç½®é¡¶ç‚¹ä½
  subscriptions JSONB DEFAULT '[]',         -- è®¢é˜…åˆ—è¡¨
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**ä¸ªäººç‚¹ä½åº“ (valorant_lineups)**

```sql
CREATE TABLE valorant_lineups (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  title TEXT,
  map_name TEXT,
  agent_name TEXT,
  agent_icon TEXT,
  skill_icon TEXT,
  side TEXT CHECK (side IN ('attack', 'defense')),
  ability_index INTEGER,
  agent_pos JSONB,        -- åœ°å›¾ä¸Šè§’è‰²ä½ç½®
  skill_pos JSONB,        -- åœ°å›¾ä¸ŠæŠ€èƒ½è½ç‚¹ä½ç½®
  stand_img TEXT,         -- ç«™ä½å›¾
  stand_desc TEXT,
  stand2_img TEXT,        -- ç«™ä½å›¾2
  stand2_desc TEXT,
  aim_img TEXT,           -- ç„ç‚¹å›¾
  aim_desc TEXT,
  aim2_img TEXT,          -- ç„ç‚¹å›¾2
  aim2_desc TEXT,
  land_img TEXT,          -- è½ç‚¹å›¾
  land_desc TEXT,
  source_link TEXT,       -- æ¥æºé“¾æ¥
  cloned_from UUID,       -- å…‹éš†æ¥æº
  author_name TEXT,
  author_avatar TEXT,
  author_uid TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**ç‚¹ä½æŠ•ç¨¿å®¡æ ¸è¡¨ (lineup_submissions)**

```sql
CREATE TABLE lineup_submissions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  submitter_id UUID REFERENCES auth.users(id),
  submitter_email TEXT,
  -- ç‚¹ä½ä¿¡æ¯å­—æ®µ (åŒ valorant_lineups)
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
  reject_reason TEXT,
  reviewed_by TEXT,
  reviewed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**ç³»ç»Ÿè®¾ç½®è¡¨ (system_settings)**

```sql
CREATE TABLE system_settings (
  id UUID PRIMARY KEY DEFAULT '00000000-0000-0000-0000-000000000001',
  official_oss_config JSONB,           -- å®˜æ–¹å›¾åºŠé…ç½®
  submission_enabled BOOLEAN DEFAULT true,
  daily_submission_limit INTEGER DEFAULT 10,
  daily_download_limit INTEGER DEFAULT 50,
  author_links JSONB,                  -- ä½œè€…é“¾æ¥ï¼ˆæ‰“èµã€è”ç³»ç­‰ï¼‰
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### Row Level Security (RLS)

```sql
-- ä¸ªäººåº“ï¼šç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
CREATE POLICY "Users can view own lineups"
  ON valorant_lineups FOR SELECT
  USING (auth.uid() = user_id);

-- å…±äº«åº“ï¼šæ‰€æœ‰äººå¯è¯»ï¼Œä»…ç®¡ç†å‘˜å¯å†™
CREATE POLICY "Anyone can view shared lineups"
  ON valorant_shared FOR SELECT USING (true);

CREATE POLICY "Only admins can modify shared lineups"
  ON valorant_shared FOR ALL
  USING (public.is_admin());

-- ç®¡ç†å‘˜æƒé™æ£€æŸ¥å‡½æ•°
CREATE FUNCTION public.is_admin() RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM user_profiles
    WHERE id = auth.uid() AND role IN ('admin', 'super_admin')
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

#### Edge Functions

**get-video-author**

- è¿è¡Œæ—¶ï¼šDeno
- ç”¨é€”ï¼šè§£æ B ç«™å’ŒæŠ–éŸ³è§†é¢‘ä½œè€…ä¿¡æ¯
- ç«¯ç‚¹ï¼š`/functions/v1/get-video-author`
- æ–¹æ³•ï¼šPOST
- è¯·æ±‚ä½“ï¼š`{ "url": "è§†é¢‘é“¾æ¥" }`
- å“åº”ï¼š
  ```json
  {
    "status": "success",
    "data": {
      "username": "ä½œè€…æ˜µç§°",
      "avatar": "å¤´åƒ URL",
      "user_home_url": "ä¸»é¡µé“¾æ¥",
      "is_cover": false,
      "source": "bilibili" | "douyin"
    }
  }
  ```

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### ç´¢å¼•è®¾è®¡

```sql
-- ä¸ªäººåº“ç´¢å¼•
CREATE INDEX idx_lineups_user_id ON valorant_lineups(user_id);
CREATE INDEX idx_lineups_map_agent ON valorant_lineups(map_name, agent_name);
CREATE INDEX idx_lineups_side ON valorant_lineups(side);
CREATE INDEX idx_lineups_cloned_from ON valorant_lineups(cloned_from);

-- å…±äº«åº“ç´¢å¼•
CREATE INDEX idx_shared_map_agent ON valorant_shared(map_name, agent_name);
CREATE INDEX idx_shared_source_id ON valorant_shared(source_id);
CREATE INDEX idx_shared_side ON valorant_shared(side);

-- æŠ•ç¨¿å®¡æ ¸ç´¢å¼•
CREATE INDEX idx_submissions_submitter ON lineup_submissions(submitter_id);
CREATE INDEX idx_submissions_status ON lineup_submissions(status);

-- æ¯æ—¥ä¸‹è½½ç´¢å¼•
CREATE INDEX idx_daily_downloads_lookup ON user_daily_downloads(user_id, date);

-- ä¸‹è½½æ—¥å¿—ç´¢å¼•
CREATE INDEX idx_download_logs_user_id ON download_logs(user_id);
CREATE INDEX idx_download_logs_created_at ON download_logs(created_at DESC);

-- ç”¨æˆ·èµ„æ–™ç´¢å¼•
CREATE INDEX idx_user_profiles_email ON user_profiles(email);
CREATE INDEX idx_user_profiles_custom_id ON user_profiles(custom_id);
```

## ç¬¬ä¸‰æ–¹é›†æˆ

### å›¾åºŠæœåŠ¡

æ”¯æŒä¸‰ç§äº‘å­˜å‚¨æœåŠ¡ï¼Œé…ç½®ä¿å­˜åœ¨ç”¨æˆ·æœ¬åœ°ï¼š

| æœåŠ¡å•† | SDK | å¤‡æ³¨ |
|--------|-----|------|
| é˜¿é‡Œäº‘ OSS | `ali-oss` | æ¨èï¼Œå›½å†…é€Ÿåº¦å¿« |
| è…¾è®¯äº‘ COS | `cos-js-sdk-v5` | AppId æ ¼å¼éœ€æ³¨æ„ |
| ä¸ƒç‰›äº‘ Kodo | `qiniu-js` | éœ€æœåŠ¡ç«¯ç”Ÿæˆ Token |

### å¤–éƒ¨ API

| API | ç”¨é€” |
|-----|------|
| [Valorant API](https://valorant-api.com) | è·å–è‹±é›„/æŠ€èƒ½/åœ°å›¾æ•°æ® |
| B ç«™ Web API | è§†é¢‘ä½œè€…ä¿¡æ¯è§£æï¼ˆEdge Functionï¼‰|
| æŠ–éŸ³ HTML è§£æ | è§†é¢‘ä½œè€…ä¿¡æ¯è§£æï¼ˆEdge Functionï¼‰|

## âš¡ æ€§èƒ½ä¼˜åŒ–

| ç±»åˆ« | ç­–ç•¥ |
|------|------|
| **ä»£ç åˆ†å‰²** | Vite è‡ªåŠ¨è·¯ç”±çº§åˆ†å‰²ï¼ŒåŠ¨æ€å¯¼å…¥å¤§å‹ç»„ä»¶ |
| **å›¾ç‰‡ä¼˜åŒ–** | ä¸Šä¼ è‡ªåŠ¨å‹ç¼©ï¼Œä½¿ç”¨ WebP/PNGï¼Œæ‡’åŠ è½½ |
| **ç¼“å­˜ç­–ç•¥** | LocalStorage é…ç½®ç¼“å­˜ï¼Œæµè§ˆå™¨ç¼“å­˜ |
| **æ¸²æŸ“ä¼˜åŒ–** | React.memoï¼ŒuseMemo/useCallback |
| **æ•°æ®åº“** | åˆç†ç´¢å¼•è®¾è®¡ï¼Œé¿å… N+1 æŸ¥è¯¢ |
| **CDN** | Vercel é™æ€èµ„æº + å›¾åºŠ CDN |

## ğŸ”’ å®‰å…¨è®¾è®¡

| ç±»åˆ« | æªæ–½ |
|------|------|
| **XSS é˜²æŠ¤** | React è‡ªåŠ¨è½¬ä¹‰ï¼Œé¿å… `dangerouslySetInnerHTML` |
| **è®¤è¯æˆæƒ** | Supabase JWT Tokenï¼ŒRLS è¡Œçº§å®‰å…¨ |
| **æ•æ„Ÿä¿¡æ¯** | ç¯å¢ƒå˜é‡ç®¡ç†ï¼Œå‰ç«¯ä¸å­˜å‚¨å¯†é’¥ |
| **API é™æµ** | Supabase è‡ªåŠ¨é™æµï¼Œæ¯æ—¥ä¸‹è½½é™åˆ¶ |

## ğŸ“ˆ ç›‘æ§å’Œæ—¥å¿—

| ç±»åˆ« | å·¥å…· |
|------|------|
| **åå°ç»Ÿè®¡** | ä¸‹è½½æ—¥å¿—ã€ç”¨æˆ·ç®¡ç†ã€ç‚¹ä½å®¡æ ¸ |
| **æ•°æ®åº“ç›‘æ§** | Supabase Dashboard |
| **é”™è¯¯æ—¥å¿—** | æµè§ˆå™¨ Consoleï¼ŒEdge Function æ—¥å¿— |

## ğŸ—ï¸ æŠ€æœ¯é€‰å‹ç†ç”±

| æŠ€æœ¯ | ç†ç”± |
|------|------|
| React | ç”Ÿæ€æˆç†Ÿï¼Œç»„ä»¶åŒ–å¼€å‘ |
| TypeScript | ç±»å‹å®‰å…¨ï¼Œå‡å°‘ Bug |
| Vite | å¿«é€Ÿæ„å»ºï¼ŒHMR ä½“éªŒå¥½ |
| VitePress | æ–‡æ¡£é™æ€ç«™ç‚¹ï¼Œä¸ä¸»åº”ç”¨ç»Ÿä¸€éƒ¨ç½² |
| Supabase | å¼€ç®±å³ç”¨ï¼Œé™ä½åç«¯æˆæœ¬ |
| Tailwind CSS | å¿«é€Ÿå¼€å‘ï¼Œæ ·å¼ä¸€è‡´ |
| Leaflet | è½»é‡çº§åœ°å›¾åº“ï¼Œè‡ªå®šä¹‰æ€§å¼º |
